<html>
<head>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css"/>
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <py-env>
        - pandas
    </py-env>
    <style>
        .mystyle {
            font-size: 11pt;
            font-family: Arial;
            border-collapse: collapse;
            border: 1px solid silver;
        }

        .mystyle td, th {
            padding: 5px;
        }

        .mystyle tr:nth-child(even) {
            background: #E0E0E0;
        }

        .mystyle tr:hover {
            background: silver;
            cursor: pointer;
        }
        a{color: red;}
    </style>
</head>

<body>
<py-title>利用 PyScript 在游览器运行 AKShare 实现数据展示及下载功能</py-title>
<div id="download" align="center"><a id="downloadLink" href="#" download>点击下载</a>
</div>
<div id="table" align="center"></div>
<py-script output="table">
    import pandas as pd
    import json

    from pyodide.http import open_url

    url = "http://{{ ip }}/api/public/{{ interface }}" # 本地 AKTools 搭建

    temp_df = pd.read_json(open_url(url))
    # temp_df['调整日期'] = pd.to_datetime(temp_df['调整日期']).dt.date
    temp_html = temp_df.to_html(classes='mystyle')
    pyscript.write('table', temp_html)

</py-script>
<script>
  (function() {
    function renderTable(data) {
      var container = document.getElementById('table');
      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = '<p>暂无数据</p>';
        return;
      }
      var columns = Object.keys(data[0] || {});
      var html = '<table class="mystyle"><thead><tr>';
      for (var i = 0; i < columns.length; i++) {
        html += '<th>' + columns[i] + '</th>';
      }
      html += '</tr></thead><tbody>';
      for (var r = 0; r < data.length; r++) {
        html += '<tr>';
        for (var c = 0; c < columns.length; c++) {
          var key = columns[c];
          var val = data[r][key];
          html += '<td>' + (val === undefined || val === null ? '' : val) + '</td>';
        }
        html += '</tr>';
      }
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function jsFallback() {
      var host = (location.host || '{{ ip }}').trim();
      var iface = (new URLSearchParams(location.search).get('interface') || '{{ interface }}' || 'stock_zh_a_spot_em');
      var url = 'http://' + host + '/api/public/' + iface;
      var dl = document.getElementById('downloadLink');
      if (dl) {
        dl.href = url;
        dl.setAttribute('download', iface + '.json');
      }
      fetch(url)
        .then(function(r) {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(renderTable)
        .catch(function(err) {
          console.error('回退加载失败:', err);
          document.getElementById('table').innerHTML = '<p style="color:red">数据加载失败：' + err + '</p>';
        });
    }

    // 如果 PyScript 未加载或被拦截，启用纯 JS 回退渲染
    if (!window.pyscript) {
      jsFallback();
    }
  })();
</script>
</body>
</html>