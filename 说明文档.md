# 说明文档

本项目唯一知识入口与执行依据，包含项目规划、实施方案与进度记录。

## 项目规划
- 目标：提供基于 AKShare 的 HTTP API 服务，稳定访问外部数据源。
- 资源：Windows 开发环境，Python 3.10，FastAPI + Uvicorn，AKShare/AKTools。
- 时间节点：问题修复即刻落地，随版本更新持续迭代。
- 风险预判：企业网络代理导致外部请求失败（ProxyError）；第三方数据源变更导致接口不兼容。

## 实施方案
- 技术选型：FastAPI + Uvicorn，AKShare 作为数据源；Typer 作为 CLI。
- 架构设计：
  - `aktools/main.py` 暴露 `FastAPI` 应用；
  - `aktools/core/api.py` 路由负责调用 AKShare 接口；
  - `aktools/utils.py` 提供通用工具函数。
- 接口协议：统一 `GET`，路径 `/api/public/{item_id}` 与 `/api/private/{item_id}`；参数经 URL 传递。
- 数据模型：AKShare 返回 `DataFrame`，序列化为 `records` 格式 JSON。

## 进度记录

### 2025-11-04 修复：ProxyError 导致 500 报错
- 实现效果：
  - 在 `aktools/utils.py` 新增 `disable_http_proxies()`，统一禁用 `HTTP_PROXY/HTTPS_PROXY/ALL_PROXY` 等环境变量，并设置 `NO_PROXY=*`；
  - 在 `aktools/main.py` 模块加载时调用 `disable_http_proxies()`，确保通过 `uvicorn main:app` 启动也生效；
  - 在 `aktools/core/api.py` 公开接口增加 `requests.exceptions.ProxyError` 捕获，返回 `502` 与友好提示。
- 测试验证结果：
  - 启动命令：`python -m aktools --host 0.0.0.0 --port 8888`
  - 访问示例：`http://0.0.0.0:8888/api/public/stock_zh_a_hist?symbol=000001`
  - 代理开启情况下不再走系统代理，外网请求直连；若网络仍受限，接口返回 `502` 并提示检查代理设置。
- 潜在问题：
  - 企业网络策略强制代理或出口拦截会导致直连失败，此时需在系统层面放行或使用出口白名单；
  - 第三方数据源变更导致接口参数或返回结构调整，需关注 AKShare 更新日志。
- 后续建议：
  - 为私有接口 `/api/private/{item_id}` 同步增加代理异常捕获（如需要登录保护场景下也返回友好提示）；
  - 在部署环境文档中明确“禁用代理与 NO_PROXY=* 的配置说明”；
  - 增加健康检查接口，检测外部数据源连通性与版本兼容性。

### 2025-11-04 修复：PyScript 资源被 ORB 拦截
- 实现效果：
  - 将 `aktools/assets/html/akscript.html` 中的 PyScript 引用从 `https://pyscript.net/alpha/...` 更新为 `https://pyscript.net/latest/...`；
  - 解决浏览器 `net::ERR_BLOCKED_BY_ORB` 报错，页面可正常加载。
- 测试验证结果：
  - 后端启动命令：`python -m aktools --host 0.0.0.0 --port 8888`
  - 访问：`http://localhost:8888/api/show`，控制台无 ORB 错误；PyScript 成功拉取数据并渲染表格，下载链接可用。
- 潜在问题：
  - 若外网受限或 CDN 路径再次变更，可能出现同类问题；
  - 建议后续在 `assets` 目录本地托管一份 PyScript 备份资源以应急。
- 后续建议：
  - 锁定 PyScript 版本号（如 `https://pyscript.net/releases/<version>/...`），并在部署清单记录；
  - 若企业网络策略严格，提供“本地资源回退”方案的切换开关。

### 2025-11-04 增强：PyScript 失败时启用纯 JS 渲染回退
- 实现效果：
  - 在 `aktools/assets/html/akscript.html` 增加 `window.pyscript` 检测；若未加载则使用 `fetch` 从 `http://<host>/api/public/<interface>` 拉取数据并渲染表格；
  - 动态解析 `location.host` 与 `?interface=` 查询参数，自动更新“点击下载”链接；默认接口使用 `stock_zh_a_hist`（可通过查询参数覆盖）。
- 测试验证结果：
  - 新启动服务：`python -m aktools --host 0.0.0.0 --port 8889` 后访问 `http://localhost:8889/api/show`，页面成功显示表格与下载按钮；
  - 在企业网络下若 CDN 被拦截，仍可通过回退逻辑展示数据。
- 潜在问题：
  - 若 AKShare 接口发生变更或需必选参数，默认接口可能返回 404，需要在 URL 中显式传入 `?interface=<接口名>` 与参数。
- 后续建议：
  - 在后端 `/api/show` 中支持 `?interface=` 参数（已改为模板渲染）；
  - 提供本地托管的 PyScript 与 Pyodide 资源的开关配置，进一步减少外部依赖风险。